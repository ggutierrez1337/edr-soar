# Lima Charlie EDR with Tines SOAR Detection and Response

# Description
This project documents the deployment and configuration of Lima Charlie for endpoint detection and response (EDR) within an AWS-hosted Windows Server 2022 environment. It includes installation steps, telemetry generation emulating an attack attempting to extract group/user info on the machine using LaZagne.exe, D&R rule creation, and integration with Slack and Tines for automated alerting and response workflows.

## Tools and Utilities

- **AWS EC2**: Hosting the Windows Server 2022 instance.
- **Lima Charlie**: EDR platform for threat detection and response.
- **PowerShell**: Used for command-line execution and automation.
- **LaZagne**: Open-source credential recovery tool for testing detections.
- **Slack**: Communication platform for real-time alerting.
- **Tines**: Automation tool for creating security workflows.
- **REST API**: Used for interacting with Lima Charlie programmatically.

## Environments
### AWS EC2 Instance Configuration

1. In AWS, create an **EC2 instance** with the following specifications:
   - **OS:** Windows Server 2022 (Base)
   - **Instance Type:** `t2.medium` (recommended: `t2.large`)
   - **Storage:** Minimum **50GB**
2. Deploy the instance and **RDP** into the server using the downloaded RDP file.
3. Authenticate using the **RSA-generated password** from AWS.

## Program Walkthrough

### Step 1: Deploy and Configure the Server

- Set up the Windows Server EC2 instance.
- Disable Windows Defender for testing purposes.
- Download and install Lima Charlie agent.

### Step 2: Generate Telemetry and Verify Lima Charlie Integration

- Run **LaZagne.exe** to generate security events.
- Navigate to **Lima Charlie Timeline** and confirm event logs.

### Step 3: Create and Test Detection and Response (D&R) Rules

- Set up a D&R rule to detect LaZagne execution.
- Test rule functionality by executing LaZagne and verifying detection logs.

### Step 4: Automate Alerts with Slack and Tines

- Integrate Lima Charlie with **Slack** for real-time notifications.
- Set up a **Tines** playbook to process detection outputs and forward alerts.

### Step 5: Implement Automated Machine Isolation

- Configure a **Tines** playbook to prompt users for isolation actions.
- Implement REST API-based isolation using Lima Charlie.
- Validate machine isolation by attempting RDP access.

## Documentation

# Deploy Client

1. In AWS, create an EC2 instance for Windows Server Base 2022 t2.medium (t2.large is recommended) and at least 50GB of storage
2. Once deployed, RDP into the client by downloading the RDP deployment and running it, password will be the RSA generated when creating the EC2 instance

# Lima Charlie Installation Key Creation

1. In Lima Charlie within the task bar, select **Installation Key,** and **Create Installation Key**

![image 1](https://github.com/user-attachments/assets/76157dd4-7cc6-4640-b3d2-c69aa67b2135)


2. Under **Sensor Downloads** in the Installation Keys tab, right click Windows 64-bit and select **Copy Link Address.** Paste the link address in the URL bar of the Server. The server will then download the installation link 

![image 2](https://github.com/user-attachments/assets/67c35baf-5063-42cb-9210-ec379e6c5e59)


![image 3](https://github.com/user-attachments/assets/57c1c062-98e4-4cb6-ba6b-bb7b7886756b)

3. Copy the **Sensor Key** from the Installation Key created earlier

![image 4](https://github.com/user-attachments/assets/860fc707-cd89-480f-a9c2-34d2d80c4665)

4. Back in the Server, run PowerShell as administrator and input the following commands:

```python
cd Downloads
lc_sensor.exe -i YOUR_INSTALLATION_KEY
```

![image](https://github.com/user-attachments/assets/06d2126d-cbe6-4bae-aedd-7985483c286c)

5. Ensure the Server has been added to the Lima Charlie Sensors List by navigating to **Sensors List** and checking if the Client has been listed

![Screenshot_(719)](https://github.com/user-attachments/assets/ef4c3263-1ca6-467a-8946-128e047c37f4)

# Generating Telemetry and Creating a D&R Rule

1. In the Server, go to the following link: 

(https://www.notion.so/14a5d3a57d5680e49505dd77313a8bf9?pvs=21)](https://github.com/AlessandroZ/LaZagne/releases/)

2. Before downloading the .exe, ensure Windows Real Time Protection is disabled. Download the **LaZagne.exe.** Since the download is blocked follow the steps as shown: click the **…** of the download → select **Keep →** Show More → **Keep Anyway**

3. In PowerShell, run the command:

This will deploy lazagne and harvest any credentials and hashes associated with their login information on the local machine

```python
.\lazagne.exe
```

4. In Lima Charlie, go **Timeline** and search in the search, input **lazagne.** Review the events generated by lazagne

![image 5](https://github.com/user-attachments/assets/6a8c3e0c-bfe1-42e1-8994-411959976e57)

## Creating D&R Rules

1. In the task bar of Lima Charlie, go to **Automations** and **D&R Rules.** Select **Create Custom Rule**

Rules do not need to be built from scratch, so instead, looking up a rule in D&R related to what the desired outcome should be will be helpful

![image 6](https://github.com/user-attachments/assets/a8d1cca3-2caf-42f3-8bfa-f34cd6dd020b)

2. Under Detect, input the following:

```python
events:
- NEW_PROCESS
- EXISTING_PROCESS
op: and 
rules:
- op: is windows
- op: or
  rules:
  - case sensitive: false
    op: ends with
  path: event/FILE_PATH
    value: lazagne.exe
  - case sensitive: false
    op: ends with
    path: event/COMMAND_LINE
    value: all
  - case sensitive: false
    op: contains
    path: event/COMMAND_LINE
    value: lazagne
  - case sensitive: false
    op: is
    path: event/HASH
    value: '467e49f1f795c1b08245ae621c59cdf06df630fc1631dc0059da9a032858a486'
```

Under Response, input the following:

```python
- action: report
  metadata:
    author: VeloSOARraptor
    description: Detects the execution of DeviceCredentialDeployment to hide a process 
      from view
    falsepositives:
    - Unlikely
    level: mediuem
    reference:
    tags:
    - attack.defense_evasion
  name: laZagne Execution
```

3. Save the new rule

4. With the new rule, the event can be tested by in D&R by selecting **Target Event,** copy/paste an event generated by lazagne, and select **Test Event** 

![image 7](https://github.com/user-attachments/assets/775a5788-a809-4b03-86ad-eed2f8ddd839)

![image 8](https://github.com/user-attachments/assets/7de8466b-407a-4515-86ff-409b9ff46eae)

5. Back in the Server, in PowerShell, run the following command:

```python
.\lazagne all
```

6. In **Timeline** tab of Lima Charlie, it can be seen that new events were generated and more importantly, **NEW_PROCESS,** which the rule created earlier applies to.

![image 9](https://github.com/user-attachments/assets/7ea69df6-c195-4b72-b155-f743ac1a984d)

Within the **COMMAND_LINE** section of the New Process, the following command was run:

```python
.\lazagne.exe all 
```

7. In Lima Charlie **Detections** tab, it can now be seen with the rule created, that the event was captured and detected for the command **.\lazagne.exe all**. Within the fields, additional information is captured as well such as: hostname, external IPs, links, etc

![image 10](https://github.com/user-attachments/assets/b44280b4-9083-4523-8c60-7023f1e42b66)

![image 9](https://github.com/user-attachments/assets/9134a5be-b803-4ede-be61-63a8d9230c67)

# Setup Slack Channel and Tines Connection Test with Lima Charlie

1. In Slack, create a **new channel** and name it **alerts.** When a detection is received from Lima Charlie on Tines, Tines will send a message to the Slack “alerts” channel as a dedicated channel for D&R
2. In Tines, create a new workspace in order to start a playbook for Detections
3. Back to Lima Charlie in the taskbar, navigate to **Outputs.** Select **Add Output → Detections → Tines.** If Tines was not an option, **Webhook** could be utilized as well

![image 12](https://github.com/user-attachments/assets/ccb5565b-be67-4206-901a-f2e7c31bbcd7)

![image 13](https://github.com/user-attachments/assets/6849c7fa-cd1c-4da4-a8c4-9994e8f0522c)

![image 14](https://github.com/user-attachments/assets/b57f2075-5da3-4e75-9a1c-153bc40b0517)

4. Make sure a webhook has been added to the Tines playbook, and copy the webhook Link. Paste the link for **Destination Host** in Lima Charlie Detections setup and then save the output

 ****

![image 15](https://github.com/user-attachments/assets/13536853-0914-4030-aecb-ca8ddebf137d)

![image 16](https://github.com/user-attachments/assets/11d613ec-b5dc-4050-85b7-b3662e9ebf10)

5. If the following prompt comes up, “**Couldn't detect any recent samples moving through this output”,** once the output has been generated, go back in the Windows Server, and rerun the command in PowerShell “**.\lazagne.exe all**”. 
6. Once the command has been run, the detection rule should pick up the event and create an output, so click **refresh sample**

![image 17](https://github.com/user-attachments/assets/8441f9e3-45be-4cbb-bd94-cdc71416349d)

7. Back in Tines under the webhook, select **Events** and expand both **body** and **detect** section. The Detection Rule created earlier with all the operators/values added in Lima Charlie will be visible in the webhook now

![image 18](https://github.com/user-attachments/assets/02e78f35-eef6-427e-ae97-cd2c493571c5)

# Build Playbook

1. In Slack, select **automations** and then search for **Tines,** then add the app to Slack
2. Back in the Tines dashboard, select your **Team** and in the drop down, select **Credentials.** Under credentials, select **New** and search for Slack. Once prompted, choose **Use Tine’s app for Slack.** 

Once completed, a new Slack credential will now be able to be used, which establishes a link between Tines and Slack

![Screenshot_(738)](https://github.com/user-attachments/assets/2a1bac83-25c9-4b82-8e0c-1ff32ba3a7d0)

3. Go back to the playbook that was being created, and select **Templates.** Choose the following template for Slack: **Send a message**
4. Back in Slack, since an **alerts** channel was created right click **alerts** and select **View Channel Details.** At the bottom of the pop up will be the **Channel ID.** Copy/Paste to the **Channel/User ID** in the Slack webhook

![image 19](https://github.com/user-attachments/assets/ca1335f3-8d93-45ea-bcdd-a781bea72ba1)

5. Click on the storyboard to de-select the Slack webhook. On the right-hand side where it says, **Credentials,** add the Slack credential that was created earlier

![image 20](https://github.com/user-attachments/assets/bd9295f1-09cd-4892-8665-810fcbbec3fc)

6. Check that the Slack webhook works, by selecting the icon and clicking **Run.** A new message was generated, so Tines is communicating with Slack as expected

![image 21](https://github.com/user-attachments/assets/2aaa40a2-cd3b-4f8b-9fb6-70f359a6e07e)

## Adding Email to Tines

1. Add the **Send Email** hook to the story board in Tines, and connect it to the **Webhook (Retrieve Detections)**

![image 22](https://github.com/user-attachments/assets/38e01a35-0d22-492c-b639-d41b3175cb3a)

2. Once the fields are filled out for the email, select **Test** on the email hook. Choose a detection that should be sent in the case of a real event, then click test
    
    An email should be sent to the desired recipient, and if so, the hook is working as expected.
    

![image 23](https://github.com/user-attachments/assets/42a25d56-a4b8-449e-8afd-e68edb28d9cf)

![image 24](https://github.com/user-attachments/assets/099c7834-2bc5-459e-a385-5d462e765e85)

## Adding User Prompt and Messages to Tines

1. In the Tines playbook under **Tools,** select **Page,** drag it to the storyboard, and connect it to the **Detection Webhook**. This page will be used to prompt the user whether to isolate their machine or not

![image 25](https://github.com/user-attachments/assets/0a9f7b95-de02-4678-bdd6-cbf845e9eec3)

2. In the **Webhook,** select **Events.** In order to create a prompt that the user understands, extract the fields from the **body** of the webhook. Desired fields are usually in the **Detection** and **Routing** section.
    
    The fields should be meaningful to the user, so they understand the context of what was found on the machine and why they’re being prompted to isolate their machine
    
    - **<<retrieve_detections.body.cat>>** - Title
    - **<<retrieve_detections.body.detect.routing.event_time>>** - Time of Event
    - **<<retrieve_detections.body.detect.routing.hostname>>** - Name of Machine
    - **<<retrieve_detections.body.detect.routing.int_ip>>** - IP address of machine
    - **<<retrieve_detections.body.detect.event.USER_NAME>>** - Name of user on the machine
    - **<<retrieve_detections.body.detect.event.FILE_PATH>>** - Process detected
    - **<<retrieve_detections.body.detect.event.COMMAND_LINE>>** - Commands ran
    - **<<retrieve_detections.body.detect.routing.sid>>** - Sensor ID given to detection output by Lima Charlie
    - **<<retrieve_detections.body.link>>**  - Detection

![image 26](https://github.com/user-attachments/assets/d73d17a6-d2d2-46f9-b978-fa7106388ead)

3. In the **Slack** hook, under **Message,** when hovering over the box, there is a **(+)** icon. Select it and under **Data** select the **Webhook** that Slack is connected to since it will be retrieving data from that webhook
    
    The webhook provides **three** data points: **body, headers, response.** When hovering over the **Result Section** of the Detection Webhook under Message for Slack, it shows the results for the latest detection
    

![image 27](https://github.com/user-attachments/assets/5d0ac8d4-bf47-4cb8-b44d-5d370b683d3d)

![image 28](https://github.com/user-attachments/assets/c251ee9c-3cae-459c-91f2-2570d3276c50)

![image 29](https://github.com/user-attachments/assets/ec934ef4-9009-4ecf-a336-fcfc061bb904)

4. Since all the data comes from the **body** of the Detection Output, click the body section and select the desired fields that should be sent to the Slack Alerts channel. Fields were listed in step two. This can also be done by Copying/Pasting the values extracted from the Detection Event earlier

![image 30](https://github.com/user-attachments/assets/9886656f-b962-4c91-920b-7b623fc7bb57)

5. In the Slack hook, select **Test** and the desired event. If working correctly, the listed values of the event will be sent to the Slack alerts channel
    
    This is the output, but can be more User Friendly. This can be done so by adding field names for each variable in the Message block
    

![image 31](https://github.com/user-attachments/assets/33ada011-a298-4695-8020-3ba1b4bdbf93)

![image 32](https://github.com/user-attachments/assets/ba5a76fb-79e7-497e-b44a-04aaf9419bf1)

6. In the **Email** hook, in the **Body** section, since this written in HTML for emails, select **Open HTML Editor.** Ensure to add the <br> tag so each field has its own line and it is formatted neatly

![image 33](https://github.com/user-attachments/assets/4584357b-0433-44da-a08c-851900261bd4)

![image 34](https://github.com/user-attachments/assets/0ce44799-cb6f-45c4-bdaf-b3b13bbbdb47)

7. Next, select **Edit Page.** Create the appropriate header with a prompt asking whether the user wishes to isolate the machine or not, and within the prompt add the same values as done with both Slack/Email hooks in the message section regarding the Detection Output. Once done, add a **boolean** to the prompt so the user can select either Yes/No

## Workflow if User Denies Isolation

1. Drag and drop a **Trigger** onto the storyboard, name it **No,** and connect it to the prompt
2. For **Rules** of the trigger add the value of **User Prompt → body → Isolate** which will detonate the trigger
3. The value of the rule should equal to **false** since the user is selecting No of the boolean value in User Prompt

![image 35](https://github.com/user-attachments/assets/b5cd8f9f-1e13-431c-b929-43528e821fb3)

4. Copy/Paste the Slack message hook and connect it to the trigger since it will be creating an action if the user selects No. Create a message in the Slack hook that will notify responders of the user’s decline of isolating the machine

![Screenshot_(758)](https://github.com/user-attachments/assets/cdeaff0b-74a7-4610-8d74-de5f895fc3d5)

5. Test the trigger by selecting **User Prompt → Visit Page →** Select **No**
    
    It can now be seen that a Slack message was sent regarding the event where the prompt was selected as **No**
    

![image 36](https://github.com/user-attachments/assets/324ed14d-b2ab-4835-b22d-f6812dadb930)

## Workflow if Machine is Isolated

1. Copy/Paste the **No Trigger** in the playbook and rename it **Yes.** Nothing will be changed except the value for **false,** will now be **true**
2. In **Templates,** select **Lima Charlie** and search for **Isolate Sensor.** This will begin the process of isolating the machine
3. Under the **Isolate Sensor URL,** changed <sid> to the actual **SID** of the Sensor for the Detection

![image 37](https://github.com/user-attachments/assets/bd75497f-36b0-4b49-88cd-9333bb3b5d6b)

![image 38](https://github.com/user-attachments/assets/4cfb1dc0-654f-4508-9427-dea8327190b5)

4. Go to Lima Charlie and under **Access Management,** select **REST API.** Copy the **Org JWT** 
5. In Tines, open the dashboard in a new tab. Under **Credentials** add **Text,** then name it Lima Charlie along with pasting the **API** in the **Value** section. Under **URLs and Domains,** input the following: ***.limacharlie.io**

![image 39](https://github.com/user-attachments/assets/f1524903-3268-4d23-a509-e3f257e9bd50)

6. Lima Charlie will automatically connect to the playbook. Back in Lima Charlie. go to **Sensors** and select the workstation that is connected to Lima Charlie. It can be seen under **Network Access** that the machine is **Allowed** currently

![image 40](https://github.com/user-attachments/assets/b6859bcf-e7ca-4750-8130-338aa55a1cfa)

7. In Tines, re-emit the event of the Webhook and instead of selecting **No** in the User Prompt, select **Yes.** Once selected the Lima Charlie API will be ran and the machine will now be isolated

![image 41](https://github.com/user-attachments/assets/5a96dde4-586c-43d8-92ad-0f2b0f7a67c0)

![image 42](https://github.com/user-attachments/assets/e10277c3-ad59-4b48-a2f9-600afb5403ae)

8. Now when trying to use RDP to access the Server, users will be unable to do so

![image 43](https://github.com/user-attachments/assets/fb9d3c11-cb12-4be0-8ad1-79d5286e6419)

9. In Tines, add a Lima Charlie template to the storyboard and for the template search for **Get Isolation Status** and connect it to the previous Lima Charlie template
10. Remember to replace the {**sid**} under **Value** with the actual {sid} of the machine which can be found in the **Retrieve Detections** webhook 

![image 44](https://github.com/user-attachments/assets/5c289942-690b-4923-a1a4-6660a87765d1)

11. Add a new **Slack** message hook, and connect it to the **Get Isolation Status.** in the message input the following:

```python
Isolation Status:<<get_isolation_status.body.is_isolated>>
The Computer: <<retrieve_detections.body.detect.routing.hostname>>
has been isolated.
```

![image 45](https://github.com/user-attachments/assets/6d4069de-88d7-4c34-999d-116841033cdc)

12. Rerun the **Retrieve Detections** webhook and in the **User Prompt,** select **Yes.** It can be seen that the machine has been isolated and a message has been sent to the **alerts** channel in Slack regarding the event as well as the isolation status

![image 46](https://github.com/user-attachments/assets/6aacee67-db56-4904-acc7-3622257c7ec6)

![image 47](https://github.com/user-attachments/assets/4c2a7bfc-27f5-42b9-8127-06d764927d34)

![Your_first_story-storyboard](https://github.com/user-attachments/assets/7b35faab-f674-4df1-803b-0efcbbacc905)


## Conclusion

This project successfully integrates Lima Charlie with **Slack** and **Tines**, enabling automated detection, response, and machine isolation in case of a security event. The system ensures rapid notification and action, reducing response time and improving security posture.

